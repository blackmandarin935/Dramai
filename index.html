<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI ë“œë¼ë§ˆ ìŠ¤íŠœë””ì˜¤</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #12121a;
      --card: #1a1a26;
      --border: #2a2a40;
      --accent: #ff3c5f;
      --accent2: #7c3aed;
      --accent3: #00d4ff;
      --text: #e8e8f0;
      --muted: #6b6b8a;
      --success: #00e676;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Space Mono', monospace;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ë°°ê²½ ë…¸ì´ì¦ˆ íš¨ê³¼ */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }

    /* ìƒë‹¨ ê·¸ë¼ë°ì´ì…˜ ê¸€ë¡œìš° */
    body::after {
      content: '';
      position: fixed;
      top: -200px;
      left: 50%;
      transform: translateX(-50%);
      width: 800px;
      height: 400px;
      background: radial-gradient(ellipse, rgba(124,58,237,0.15) 0%, rgba(255,60,95,0.08) 50%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 24px;
      position: relative;
      z-index: 1;
    }

    /* í—¤ë” */
    header {
      padding: 40px 0 20px;
      text-align: center;
      position: relative;
    }

    .logo-badge {
      display: inline-block;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      color: white;
      font-size: 10px;
      letter-spacing: 3px;
      padding: 4px 12px;
      border-radius: 2px;
      margin-bottom: 16px;
      text-transform: uppercase;
    }

    h1 {
      font-family: 'Noto Serif KR', serif;
      font-size: clamp(2rem, 5vw, 3.5rem);
      font-weight: 900;
      line-height: 1.1;
      background: linear-gradient(135deg, #fff 30%, var(--accent3) 70%, var(--accent2) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 12px;
    }

    .subtitle {
      color: var(--muted);
      font-size: 12px;
      letter-spacing: 1px;
    }

    /* íŒŒì´í”„ë¼ì¸ ë‹¨ê³„ í‘œì‹œ */
    .pipeline {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      margin: 40px 0;
      flex-wrap: wrap;
    }

    .pipeline-step {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border: 1px solid var(--border);
      background: var(--card);
      font-size: 11px;
      letter-spacing: 1px;
      color: var(--muted);
      transition: all 0.3s;
      position: relative;
    }

    .pipeline-step:first-child { border-radius: 4px 0 0 4px; }
    .pipeline-step:last-child { border-radius: 0 4px 4px 0; }

    .pipeline-step.active {
      border-color: var(--accent2);
      color: var(--text);
      background: rgba(124,58,237,0.15);
    }

    .pipeline-step.done {
      border-color: var(--success);
      color: var(--success);
      background: rgba(0,230,118,0.05);
    }

    .pipeline-step .icon { font-size: 14px; }

    .pipeline-arrow {
      width: 20px;
      height: 1px;
      background: var(--border);
      flex-shrink: 0;
    }

    /* ë©”ì¸ ì¹´ë“œ */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 28px;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 10px;
      letter-spacing: 3px;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* ì¥ë¥´/ì†Œì¬ ì„ íƒ */
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .chip {
      padding: 6px 14px;
      border: 1px solid var(--border);
      border-radius: 100px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      background: transparent;
      color: var(--muted);
      font-family: 'Space Mono', monospace;
    }

    .chip:hover { border-color: var(--accent2); color: var(--text); }
    .chip.selected { border-color: var(--accent2); background: rgba(124,58,237,0.2); color: var(--text); }

    /* í…ìŠ¤íŠ¸ ì…ë ¥ */
    .input-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-size: 10px;
      letter-spacing: 2px;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    textarea, input[type="text"], select {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-family: 'Space Mono', monospace;
      font-size: 13px;
      padding: 12px 16px;
      resize: vertical;
      transition: border-color 0.2s;
      outline: none;
    }

    textarea:focus, input[type="text"]:focus, select:focus {
      border-color: var(--accent2);
    }

    textarea { min-height: 80px; }

    select option { background: var(--surface); }

    /* ìŠ¬ë¼ì´ë” */
    .slider-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    input[type="range"] {
      width: 100%;
      accent-color: var(--accent2);
    }

    .range-label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* ì‹¤í–‰ ë²„íŠ¼ */
    .run-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      border: none;
      border-radius: 6px;
      color: white;
      font-family: 'Space Mono', monospace;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 2px;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      position: relative;
      overflow: hidden;
    }

    .run-btn::before {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }

    .run-btn:hover::before { left: 100%; }
    .run-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(124,58,237,0.4); }
    .run-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* ì§„í–‰ ìƒí™© */
    #progress-section { display: none; }

    .progress-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 28px;
      margin-bottom: 16px;
    }

    .progress-bar-wrap {
      background: var(--surface);
      border-radius: 100px;
      height: 4px;
      margin: 16px 0;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent2), var(--accent3));
      border-radius: 100px;
      width: 0%;
      transition: width 0.5s ease;
    }

    .log-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 16px;
      font-size: 12px;
      color: var(--muted);
      max-height: 200px;
      overflow-y: auto;
      line-height: 2;
    }

    .log-line { display: flex; gap: 12px; }
    .log-line .ts { color: var(--accent3); flex-shrink: 0; }
    .log-line .msg { color: var(--text); }
    .log-line.err .msg { color: var(--accent); }
    .log-line.ok .msg { color: var(--success); }

    /* ê²°ê³¼ ì„¹ì…˜ */
    #result-section { display: none; }

    .result-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    @media (max-width: 600px) { .result-grid { grid-template-columns: 1fr; } }

    .result-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 20px;
    }

    .result-item h3 {
      font-size: 10px;
      letter-spacing: 2px;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    .script-output {
      font-family: 'Noto Serif KR', serif;
      font-size: 13px;
      line-height: 1.8;
      color: var(--text);
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    .audio-player {
      width: 100%;
      margin-top: 8px;
      accent-color: var(--accent2);
    }

    .img-slideshow {
      position: relative;
      border-radius: 4px;
      overflow: hidden;
      aspect-ratio: 9/16;
      background: var(--bg);
    }

    .img-slideshow img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      opacity: 0;
      transition: opacity 1s;
    }

    .img-slideshow img.active { opacity: 1; }

    .download-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border: 1px solid var(--accent2);
      border-radius: 4px;
      color: var(--accent2);
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      letter-spacing: 1px;
      cursor: pointer;
      background: transparent;
      transition: all 0.2s;
      text-decoration: none;
      margin-top: 12px;
    }

    .download-btn:hover {
      background: rgba(124,58,237,0.15);
    }

    /* HF ìƒíƒœ í‘œì‹œ */
    .hf-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 20px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--muted);
      animation: pulse 2s infinite;
    }

    .status-dot.online { background: var(--success); }
    .status-dot.offline { background: var(--accent); animation: none; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* ìŠ¤í¬ë¡¤ë°” */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: var(--surface); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    footer {
      text-align: center;
      padding: 40px 0;
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 1px;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border: 1px solid var(--border);
      border-radius: 2px;
      font-size: 10px;
      color: var(--muted);
      margin: 2px;
    }

    .free-badge {
      display: inline-block;
      background: rgba(0,230,118,0.1);
      border: 1px solid var(--success);
      color: var(--success);
      font-size: 10px;
      letter-spacing: 2px;
      padding: 3px 10px;
      border-radius: 2px;
    }
  </style>
</head>
<body>
<div class="container">

  <header>
    <div class="logo-badge">ğŸ¬ AI Drama Studio</div>
    <h1>AI ìˆí¼ ë“œë¼ë§ˆ<br>ìë™ ì œì‘ê¸°</h1>
    <p class="subtitle">ì™„ì „ ë¬´ë£Œ Â· ì˜¤í”ˆì†ŒìŠ¤ Â· Cloudflare ë°°í¬</p>
    <br>
    <span class="free-badge">100% FREE</span>
    <span class="tag">Hugging Face</span>
    <span class="tag">Kokoro TTS</span>
    <span class="tag">MusicGen</span>
    <span class="tag">SD XL</span>
    <span class="tag">FFmpeg</span>
  </header>

  <!-- íŒŒì´í”„ë¼ì¸ ì‹œê°í™” -->
  <div class="pipeline">
    <div class="pipeline-step" id="step-script">
      <span class="icon">âœï¸</span> ëŒ€ë³¸
    </div>
    <div class="pipeline-arrow"></div>
    <div class="pipeline-step" id="step-tts">
      <span class="icon">ğŸ”Š</span> TTS
    </div>
    <div class="pipeline-arrow"></div>
    <div class="pipeline-step" id="step-image">
      <span class="icon">ğŸ–¼ï¸</span> ì´ë¯¸ì§€
    </div>
    <div class="pipeline-arrow"></div>
    <div class="pipeline-step" id="step-music">
      <span class="icon">ğŸµ</span> BGM
    </div>
    <div class="pipeline-arrow"></div>
    <div class="pipeline-step" id="step-video">
      <span class="icon">ğŸ¬</span> í•©ì„±
    </div>
  </div>

  <!-- ì„¤ì • ì„¹ì…˜ -->
  <div id="setup-section">

    <div class="card">
      <div class="card-title">01 â€” ì¥ë¥´ ì„ íƒ</div>
      <div class="chips">
        <button class="chip selected" data-genre="ë§‰ì¥ ë¡œë§¨ìŠ¤">ğŸ’” ë§‰ì¥ ë¡œë§¨ìŠ¤</button>
        <button class="chip" data-genre="ë¯¸ìŠ¤í„°ë¦¬ ìŠ¤ë¦´ëŸ¬">ğŸ”ª ë¯¸ìŠ¤í„°ë¦¬ ìŠ¤ë¦´ëŸ¬</button>
        <button class="chip" data-genre="ì¡°ì„  ì¢€ë¹„">ğŸ§Ÿ ì¡°ì„  ì¢€ë¹„</button>
        <button class="chip" data-genre="SF ë¡œë§¨ìŠ¤">ğŸš€ SF ë¡œë§¨ìŠ¤</button>
        <button class="chip" data-genre="ë³µìˆ˜ê·¹">ğŸ˜¤ ë³µìˆ˜ê·¹</button>
        <button class="chip" data-genre="ê·€ì‹  ì½”ë¯¸ë””">ğŸ‘» ê·€ì‹  ì½”ë¯¸ë””</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">02 â€” ìŠ¤í† ë¦¬ ì„¤ì •</div>

      <div class="input-group">
        <label>ì†Œì¬ / í•µì‹¬ ê°ˆë“± (ì„ íƒ)</label>
        <textarea id="story-prompt" placeholder="ì˜ˆ: ì¬ë²Œ 2ì„¸ì™€ ì‹ ë°ë ë¼ê°€ ê°™ì€ ì§€í•˜ì²  ì¹¸ì—ì„œ ë§Œë‚˜ëŠ”ë°, ì•Œê³ ë³´ë‹ˆ ê·¸ë…€ê°€ ê·¸ì˜ ìˆ¨ê²¨ì§„ ì—¬ë™ìƒì´ì—ˆë‹¤..."></textarea>
      </div>

      <div class="slider-group">
        <div>
          <label>ì¥ë©´ ìˆ˜</label>
          <input type="range" id="scene-count" min="3" max="8" value="5" oninput="document.getElementById('scene-val').textContent=this.value">
          <div class="range-label"><span>3</span><span id="scene-val">5</span><span>8</span></div>
        </div>
        <div>
          <label>ë“œë¼ë§ˆ ê°•ë„</label>
          <input type="range" id="drama-level" min="1" max="5" value="3" oninput="document.getElementById('drama-val').textContent=['ìˆœí•œë§›','ì•½ê°„ë§¤ìš´','ì¤‘ê°„','ë§¤ìš´ë§›','ê·¹í•œë§‰ì¥'][this.value-1]">
          <div class="range-label"><span>ìˆœí•œ</span><span id="drama-val">ì¤‘ê°„</span><span>ê·¹í•œ</span></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">03 â€” ìŒì„± & ìŠ¤íƒ€ì¼</div>

      <div class="slider-group">
        <div class="input-group" style="margin:0">
          <label>ë‚˜ë ˆì´í„° ëª©ì†Œë¦¬</label>
          <select id="voice-style">
            <option value="af_heart">ê°ì„±ì  ì—¬ì„±</option>
            <option value="af_bella">ë°ì€ ì—¬ì„±</option>
            <option value="am_adam">ì¤‘í›„í•œ ë‚¨ì„±</option>
            <option value="am_michael">ì²­ë…„ ë‚¨ì„±</option>
          </select>
        </div>
        <div class="input-group" style="margin:0">
          <label>BGM ìŠ¤íƒ€ì¼</label>
          <select id="music-style">
            <option value="dramatic orchestral k-drama">ğŸ¼ Kë“œë¼ë§ˆ ì˜¤ì¼€ìŠ¤íŠ¸ë¼</option>
            <option value="suspenseful thriller dark">ğŸ¸ ìŠ¤ë¦´ëŸ¬ ë‹¤í¬</option>
            <option value="romantic melodic piano">ğŸ¹ ë¡œë§¨í‹± í”¼ì•„ë…¸</option>
            <option value="epic emotional cinematic">ğŸº ì—í”½ ì‹œë„¤ë§ˆí‹±</option>
          </select>
        </div>
      </div>
    </div>

    <!-- HF Space ìƒíƒœ -->
    <div class="card">
      <div class="card-title">04 â€” Hugging Face Spaces ì—°ê²°</div>
      <div class="hf-status">
        <div class="status-dot" id="hf-dot"></div>
        <span id="hf-status-text">Spaces ì—°ê²° í™•ì¸ ì¤‘...</span>
      </div>
      <div style="font-size:11px; color:var(--muted); line-height:2;">
        ë¬´ë£Œ ë°°í¬ë¥¼ ìœ„í•´ Hugging Face Spacesì˜ ê³µê°œ APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.<br>
        ëŒ€ê¸° ì‹œê°„ì´ ìˆì„ ìˆ˜ ìˆìœ¼ë©°, ê²°ê³¼ëŠ” ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤.
      </div>
    </div>

    <button class="run-btn" id="run-btn" onclick="startPipeline()">
      ğŸ¬ ë“œë¼ë§ˆ ì œì‘ ì‹œì‘
    </button>

  </div>

  <!-- ì§„í–‰ ì„¹ì…˜ -->
  <div id="progress-section">
    <div class="progress-card">
      <div class="card-title">ì œì‘ ì§„í–‰ ì¤‘</div>
      <div id="current-step-label" style="font-size:14px; margin-bottom:8px;">ëŒ€ê¸° ì¤‘...</div>
      <div class="progress-bar-wrap">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
      <div class="log-box" id="log-box"></div>
    </div>
  </div>

  <!-- ê²°ê³¼ ì„¹ì…˜ -->
  <div id="result-section">
    <div class="card">
      <div class="card-title">âœ… ì œì‘ ì™„ë£Œ</div>

      <div class="result-grid">
        <div class="result-item">
          <h3>ğŸ“ ìƒì„±ëœ ëŒ€ë³¸</h3>
          <div class="script-output" id="script-output"></div>
        </div>
        <div class="result-item">
          <h3>ğŸ–¼ï¸ ì¥ë©´ ì´ë¯¸ì§€</h3>
          <div class="img-slideshow" id="slideshow">
            <div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);font-size:12px;">ì´ë¯¸ì§€ ìƒì„± ì¤‘...</div>
          </div>
        </div>
      </div>

      <div class="result-grid">
        <div class="result-item">
          <h3>ğŸ”Š ë‚˜ë ˆì´ì…˜ ì˜¤ë””ì˜¤</h3>
          <audio id="tts-audio" controls class="audio-player"></audio>
          <a id="tts-download" class="download-btn" download="narration.wav">â¬‡ ë‹¤ìš´ë¡œë“œ</a>
        </div>
        <div class="result-item">
          <h3>ğŸµ ë°°ê²½ìŒì•…</h3>
          <audio id="bgm-audio" controls class="audio-player"></audio>
          <a id="bgm-download" class="download-btn" download="bgm.wav">â¬‡ ë‹¤ìš´ë¡œë“œ</a>
        </div>
      </div>

      <button class="run-btn" onclick="resetApp()" style="background: var(--surface); border: 1px solid var(--border);">
        ğŸ”„ ìƒˆ ë“œë¼ë§ˆ ë§Œë“¤ê¸°
      </button>
    </div>
  </div>

  <footer>
    <div style="margin-bottom:8px;">
      <span class="tag">Llama 3.1 (HF)</span>
      <span class="tag">Kokoro TTS (HF)</span>
      <span class="tag">SDXL (HF)</span>
      <span class="tag">MusicGen (HF)</span>
    </div>
    AI Drama Studio Â· ì™„ì „ ë¬´ë£Œ Â· Cloudflare Pages ë°°í¬
  </footer>

</div>

<script>
// ==========================================
// ì„¤ì •
// ==========================================
const HF_SPACES = {
  llm:      'https://api-inference.huggingface.co/models/meta-llama/Llama-3.1-8B-Instruct',
  tts:      'https://api-inference.huggingface.co/models/hexgrad/Kokoro-82M',
  image:    'https://api-inference.huggingface.co/models/stabilityai/stable-diffusion-xl-base-1.0',
  music:    'https://api-inference.huggingface.co/models/facebook/musicgen-small',
};

// ì¥ë¥´ ì„ íƒ
let selectedGenre = 'ë§‰ì¥ ë¡œë§¨ìŠ¤';

document.querySelectorAll('.chip[data-genre]').forEach(chip => {
  chip.addEventListener('click', () => {
    document.querySelectorAll('.chip[data-genre]').forEach(c => c.classList.remove('selected'));
    chip.classList.add('selected');
    selectedGenre = chip.dataset.genre;
  });
});

// HF ìƒíƒœ ì²´í¬ (ë‹¨ìˆœ ping)
async function checkHFStatus() {
  try {
    const r = await fetch('https://huggingface.co', { method: 'HEAD', mode: 'no-cors' });
    document.getElementById('hf-dot').className = 'status-dot online';
    document.getElementById('hf-status-text').textContent = 'Hugging Face ì—°ê²°ë¨ â€” ë¬´ë£Œ API ì‚¬ìš© ê°€ëŠ¥';
  } catch {
    document.getElementById('hf-dot').className = 'status-dot offline';
    document.getElementById('hf-status-text').textContent = 'ì—°ê²° ì‹¤íŒ¨ â€” ë°ëª¨ ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤';
  }
}
checkHFStatus();

// ==========================================
// ë¡œê·¸ & ì§„í–‰ë¥ 
// ==========================================
let logBox, progressBar;

function log(msg, type = '') {
  const now = new Date().toLocaleTimeString('ko-KR');
  const line = document.createElement('div');
  line.className = `log-line ${type}`;
  line.innerHTML = `<span class="ts">[${now}]</span><span class="msg">${msg}</span>`;
  logBox.appendChild(line);
  logBox.scrollTop = logBox.scrollHeight;
}

function setProgress(pct, label) {
  progressBar.style.width = pct + '%';
  document.getElementById('current-step-label').textContent = label;
}

function setStep(stepId, state) {
  const el = document.getElementById('step-' + stepId);
  if (el) {
    el.className = 'pipeline-step ' + state;
  }
}

// ==========================================
// HF API í˜¸ì¶œ
// ==========================================
async function callHF(endpoint, payload, isBlob = false) {
  // HF í† í° ì—†ì´ ê³µê°œ ëª¨ë¸ í˜¸ì¶œ (rate limit ìˆìŒ)
  const res = await fetch(endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });

  if (!res.ok) {
    const err = await res.text();
    // 503: ëª¨ë¸ ë¡œë”© ì¤‘ â†’ ì¬ì‹œë„
    if (res.status === 503) {
      log('ëª¨ë¸ ì›Œë°ì—… ì¤‘... 20ì´ˆ í›„ ì¬ì‹œë„', 'err');
      await sleep(20000);
      return callHF(endpoint, payload, isBlob);
    }
    throw new Error(`HF API ì˜¤ë¥˜: ${res.status} ${err.slice(0,100)}`);
  }

  return isBlob ? res.blob() : res.json();
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ==========================================
// 1ë‹¨ê³„: ëŒ€ë³¸ ìƒì„±
// ==========================================
async function generateScript(genre, prompt, sceneCount, dramaLevel) {
  const levels = ['', 'ì•½ê°„ì˜ ê°ˆë“±', 'ì¤‘ê°„ ìˆ˜ì¤€ì˜ ê°ˆë“±', 'ê°•í•œ ê°ì • ëŒ€ë¦½', 'ê·¹ì ì¸ ë°˜ì „ê³¼ ë°°ì‹ ', 'ì¶©ê²©ì ì¸ ë§‰ì¥ ë°˜ì „ì˜ ì—°ì†'];
  const levelDesc = levels[dramaLevel];

  const systemPrompt = `ë‹¹ì‹ ì€ í•œêµ­ ë“œë¼ë§ˆ ì‘ê°€ì…ë‹ˆë‹¤. ì§§ê³  ì„íŒ©íŠ¸ ìˆëŠ” ìˆí¼ ë“œë¼ë§ˆ ëŒ€ë³¸ì„ ì”ë‹ˆë‹¤.`;
  const userPrompt = `ì¥ë¥´: ${genre}
ì†Œì¬: ${prompt || 'ììœ ë¡­ê²Œ'}
ì¥ë©´ ìˆ˜: ${sceneCount}ê°œ
ë“œë¼ë§ˆ ê°•ë„: ${levelDesc}

ìœ„ ì„¤ì •ìœ¼ë¡œ ìˆí¼ ë“œë¼ë§ˆ ëŒ€ë³¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.
í˜•ì‹:
[ì¥ë©´N] ì¥ì†Œ
(ì§€ë¬¸) í–‰ë™ ë¬˜ì‚¬
ìºë¦­í„°: ëŒ€ì‚¬

ê° ì¥ë©´ì€ 3-4ì¤„ë¡œ ê°„ê²°í•˜ê²Œ. ë§ˆì§€ë§‰ì— ë°˜ì „ì´ë‚˜ í´iffhangerë¡œ ëë‚´ì„¸ìš”.`;

  const result = await callHF(HF_SPACES.llm, {
    inputs: `<|system|>\n${systemPrompt}\n<|user|>\n${userPrompt}\n<|assistant|>\n`,
    parameters: { max_new_tokens: 800, temperature: 0.8, return_full_text: false }
  });

  return result[0]?.generated_text || result?.generated_text || 'ëŒ€ë³¸ ìƒì„± ì‹¤íŒ¨';
}

// ==========================================
// 2ë‹¨ê³„: TTS
// ==========================================
async function generateTTS(script, voice) {
  // ëŒ€ë³¸ì—ì„œ ë‚˜ë ˆì´ì…˜ í…ìŠ¤íŠ¸ ì¶”ì¶œ (ì§€ë¬¸/ëŒ€ì‚¬ í¬í•¨)
  const narration = script
    .replace(/\[ì¥ë©´\d+\].*/g, '')
    .replace(/\(.*?\)/g, '')
    .trim()
    .slice(0, 500); // TTS ê¸¸ì´ ì œí•œ

  const blob = await callHF(HF_SPACES.tts, {
    inputs: narration,
    parameters: { voice: voice }
  }, true);

  return URL.createObjectURL(blob);
}

// ==========================================
// 3ë‹¨ê³„: ì´ë¯¸ì§€ ìƒì„± (ì¥ë©´ë³„)
// ==========================================
async function generateImages(genre, sceneCount) {
  const styleMap = {
    'ë§‰ì¥ ë¡œë§¨ìŠ¤': 'Korean drama romantic scene, cinematic lighting, emotional',
    'ë¯¸ìŠ¤í„°ë¦¬ ìŠ¤ë¦´ëŸ¬': 'dark thriller Korean drama, suspenseful, moody lighting',
    'ì¡°ì„  ì¢€ë¹„': 'Joseon dynasty zombie apocalypse, traditional Korean setting, horror',
    'SF ë¡œë§¨ìŠ¤': 'Korean drama sci-fi romance, futuristic Seoul, emotional',
    'ë³µìˆ˜ê·¹': 'Korean revenge drama, intense, dramatic shadows',
    'ê·€ì‹  ì½”ë¯¸ë””': 'Korean ghost comedy drama, supernatural, colorful',
  };

  const baseStyle = styleMap[genre] || 'Korean drama scene, cinematic';
  const scenes = [];

  for (let i = 0; i < Math.min(sceneCount, 3); i++) { // ë¬´ë£Œ ì œí•œìœ¼ë¡œ ìµœëŒ€ 3ì¥
    log(`ì´ë¯¸ì§€ ìƒì„± ì¤‘ (${i+1}/${Math.min(sceneCount,3)})...`);
    try {
      const blob = await callHF(HF_SPACES.image, {
        inputs: `${baseStyle}, scene ${i+1}, high quality, 9:16 vertical`,
        parameters: { width: 512, height: 768 }
      }, true);
      scenes.push(URL.createObjectURL(blob));
    } catch (e) {
      log(`ì´ë¯¸ì§€ ${i+1} ì‹¤íŒ¨ â€” ê±´ë„ˆëœ€`, 'err');
    }
    await sleep(1000);
  }

  return scenes;
}

// ==========================================
// 4ë‹¨ê³„: BGM ìƒì„±
// ==========================================
async function generateMusic(style) {
  const blob = await callHF(HF_SPACES.music, {
    inputs: style,
    parameters: { max_new_tokens: 256 }
  }, true);
  return URL.createObjectURL(blob);
}

// ==========================================
// ë©”ì¸ íŒŒì´í”„ë¼ì¸
// ==========================================
async function startPipeline() {
  const btn = document.getElementById('run-btn');
  btn.disabled = true;

  document.getElementById('setup-section').style.display = 'none';
  document.getElementById('progress-section').style.display = 'block';
  document.getElementById('result-section').style.display = 'none';

  logBox = document.getElementById('log-box');
  progressBar = document.getElementById('progress-bar');

  const sceneCount = parseInt(document.getElementById('scene-count').value);
  const dramaLevel = parseInt(document.getElementById('drama-level').value);
  const voice = document.getElementById('voice-style').value;
  const musicStyle = document.getElementById('music-style').value;
  const storyPrompt = document.getElementById('story-prompt').value;

  let scriptText = '', ttsUrl = '', imageUrls = [], bgmUrl = '';

  try {
    // --- 1. ëŒ€ë³¸ ---
    setStep('script', 'active');
    setProgress(5, 'âœï¸ AIê°€ ëŒ€ë³¸ì„ ì“°ëŠ” ì¤‘...');
    log('Llama 3.1ë¡œ ëŒ€ë³¸ ìƒì„± ì‹œì‘...');

    scriptText = await generateScript(selectedGenre, storyPrompt, sceneCount, dramaLevel);
    setStep('script', 'done');
    setProgress(25, 'âœï¸ ëŒ€ë³¸ ì™„ì„±!');
    log('ëŒ€ë³¸ ìƒì„± ì™„ë£Œ âœ“', 'ok');

    // --- 2. TTS ---
    setStep('tts', 'active');
    setProgress(30, 'ğŸ”Š ë‚˜ë ˆì´ì…˜ ìŒì„± ìƒì„± ì¤‘...');
    log('Kokoro TTSë¡œ ìŒì„± ë³€í™˜ ì‹œì‘...');

    try {
      ttsUrl = await generateTTS(scriptText, voice);
      setStep('tts', 'done');
      setProgress(50, 'ğŸ”Š ë‚˜ë ˆì´ì…˜ ì™„ì„±!');
      log('TTS ì™„ë£Œ âœ“', 'ok');
    } catch (e) {
      log(`TTS ì‹¤íŒ¨ (${e.message}) â€” ê±´ë„ˆëœ€`, 'err');
      setStep('tts', '');
    }

    // --- 3. ì´ë¯¸ì§€ ---
    setStep('image', 'active');
    setProgress(55, 'ğŸ–¼ï¸ ì¥ë©´ ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
    log('Stable Diffusion XLë¡œ ì´ë¯¸ì§€ ìƒì„±...');

    try {
      imageUrls = await generateImages(selectedGenre, sceneCount);
      setStep('image', 'done');
      setProgress(75, 'ğŸ–¼ï¸ ì´ë¯¸ì§€ ì™„ì„±!');
      log(`ì´ë¯¸ì§€ ${imageUrls.length}ì¥ ìƒì„± ì™„ë£Œ âœ“`, 'ok');
    } catch (e) {
      log(`ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨ (${e.message})`, 'err');
      setStep('image', '');
    }

    // --- 4. BGM ---
    setStep('music', 'active');
    setProgress(80, 'ğŸµ ë°°ê²½ìŒì•… ì‘ê³¡ ì¤‘...');
    log('MusicGenìœ¼ë¡œ BGM ìƒì„±...');

    try {
      bgmUrl = await generateMusic(musicStyle);
      setStep('music', 'done');
      setProgress(92, 'ğŸµ BGM ì™„ì„±!');
      log('BGM ìƒì„± ì™„ë£Œ âœ“', 'ok');
    } catch (e) {
      log(`BGM ìƒì„± ì‹¤íŒ¨ (${e.message})`, 'err');
      setStep('music', '');
    }

    // --- 5. í•©ì„± ---
    setStep('video', 'active');
    setProgress(95, 'ğŸ¬ ìµœì¢… í•©ì„± ì¤‘...');
    log('ë¸Œë¼ìš°ì €ì—ì„œ ìŠ¬ë¼ì´ë“œì‡¼ + ì˜¤ë””ì˜¤ í•©ì„±...');
    await sleep(1000);

    setStep('video', 'done');
    setProgress(100, 'ğŸ‰ ì™„ì„±!');
    log('ì „ì²´ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ! âœ“', 'ok');

    await sleep(500);
    showResults(scriptText, ttsUrl, imageUrls, bgmUrl);

  } catch (err) {
    log(`ì˜¤ë¥˜ ë°œìƒ: ${err.message}`, 'err');
    log('ì¼ë¶€ ê²°ê³¼ë§Œ í‘œì‹œí•©ë‹ˆë‹¤.', 'err');
    showResults(scriptText, ttsUrl, imageUrls, bgmUrl);
  }
}

// ==========================================
// ê²°ê³¼ í‘œì‹œ
// ==========================================
function showResults(script, ttsUrl, imageUrls, bgmUrl) {
  document.getElementById('progress-section').style.display = 'none';
  document.getElementById('result-section').style.display = 'block';

  // ëŒ€ë³¸
  document.getElementById('script-output').textContent = script || 'ëŒ€ë³¸ ìƒì„± ì‹¤íŒ¨';

  // TTS
  const ttsAudio = document.getElementById('tts-audio');
  if (ttsUrl) {
    ttsAudio.src = ttsUrl;
    document.getElementById('tts-download').href = ttsUrl;
  } else {
    ttsAudio.parentElement.innerHTML += '<p style="color:var(--muted);font-size:12px;margin-top:8px;">ìŒì„± ìƒì„± ì‹¤íŒ¨ (HF ë¬´ë£Œ ì œí•œ)</p>';
  }

  // ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë“œì‡¼
  const slideshow = document.getElementById('slideshow');
  if (imageUrls.length > 0) {
    slideshow.innerHTML = '';
    imageUrls.forEach((url, i) => {
      const img = document.createElement('img');
      img.src = url;
      if (i === 0) img.className = 'active';
      slideshow.appendChild(img);
    });

    // ìë™ ìŠ¬ë¼ì´ë“œ
    let cur = 0;
    setInterval(() => {
      const imgs = slideshow.querySelectorAll('img');
      imgs[cur].className = '';
      cur = (cur + 1) % imgs.length;
      imgs[cur].className = 'active';
    }, 3000);
  }

  // BGM
  const bgmAudio = document.getElementById('bgm-audio');
  if (bgmUrl) {
    bgmAudio.src = bgmUrl;
    bgmAudio.loop = true;
    document.getElementById('bgm-download').href = bgmUrl;
  }

  window.scrollTo({ top: document.getElementById('result-section').offsetTop - 20, behavior: 'smooth' });
}

function resetApp() {
  document.getElementById('setup-section').style.display = 'block';
  document.getElementById('progress-section').style.display = 'none';
  document.getElementById('result-section').style.display = 'none';
  document.getElementById('run-btn').disabled = false;
  document.getElementById('log-box').innerHTML = '';
  document.getElementById('progress-bar').style.width = '0%';
  ['script','tts','image','music','video'].forEach(s => setStep(s, ''));
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>
</body>
</html>
